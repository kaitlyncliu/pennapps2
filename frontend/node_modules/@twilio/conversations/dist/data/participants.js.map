{"version":3,"file":"participants.js","sources":["../../src/data/participants.ts"],"sourcesContent":["import {\n  ParticipantDescriptor,\n  Participant,\n  ParticipantUpdatedEventArgs,\n  ParticipantUpdateReason,\n  ParticipantEmailBinding,\n} from \"../participant\";\nimport { Logger } from \"../logger\";\n\nimport { Conversation } from \"../conversation\";\n\nimport { SyncMap, SyncClient } from \"twilio-sync\";\nimport { Users } from \"./users\";\nimport { CommandExecutor } from \"../command-executor\";\nimport { AddParticipantRequest } from \"../interfaces/commands/add-participant\";\nimport { Configuration } from \"../configuration\";\nimport { ParticipantResponse } from \"../interfaces/commands/participant-response\";\nimport { ReplayEventEmitter } from \"@twilio/replay-event-emitter\";\nimport { JSONValue } from \"../types\";\n\ntype ParticipantsEvents = {\n  participantJoined: (participant: Participant) => void;\n  participantLeft: (participant: Participant) => void;\n  participantUpdated: (data: {\n    participant: Participant;\n    updateReasons: ParticipantUpdateReason[];\n  }) => void;\n};\n\nconst log = Logger.scope(\"Participants\");\n\nexport interface ParticipantsServices {\n  syncClient: SyncClient;\n  users: Users;\n  commandExecutor: CommandExecutor;\n}\n\ninterface ParticipantsLinks {\n  participants: string;\n}\n\nexport interface ParticipantBindingOptions {\n  email?: ParticipantEmailBinding;\n}\n\n/**\n * @classdesc Represents the collection of participants for the conversation\n * @fires Participants#participantJoined\n * @fires Participants#participantLeft\n * @fires Participants#participantUpdated\n */\nclass Participants extends ReplayEventEmitter<ParticipantsEvents> {\n  private readonly configuration: Configuration;\n  private readonly services: ParticipantsServices;\n  private readonly links: ParticipantsLinks;\n\n  rosterEntityPromise: Promise<SyncMap> | null = null;\n\n  public readonly conversation: Conversation;\n  public readonly participants: Map<string, Participant>;\n\n  constructor(\n    conversation: Conversation,\n    participants: Map<string, Participant>,\n    links: ParticipantsLinks,\n    configuration: Configuration,\n    services: ParticipantsServices\n  ) {\n    super();\n    this.conversation = conversation;\n    this.participants = participants;\n    this.links = links;\n    this.configuration = configuration;\n    this.services = services;\n  }\n\n  async unsubscribe(): Promise<void> {\n    if (this.rosterEntityPromise) {\n      const entity = await this.rosterEntityPromise;\n      entity.close();\n      this.rosterEntityPromise = null;\n    }\n  }\n\n  subscribe(rosterObjectName: string) {\n    return (this.rosterEntityPromise =\n      this.rosterEntityPromise ||\n      this.services.syncClient\n        .map({ id: rosterObjectName, mode: \"open_existing\" })\n        .then((rosterMap) => {\n          rosterMap.on(\"itemAdded\", (args) => {\n            log.debug(this.conversation.sid + \" itemAdded: \" + args.item.key);\n            this.upsertParticipant(args.item.key, args.item.data).then(\n              (participant) => {\n                this.emit(\"participantJoined\", participant);\n              }\n            );\n          });\n\n          rosterMap.on(\"itemRemoved\", (args) => {\n            log.debug(this.conversation.sid + \" itemRemoved: \" + args.key);\n            const participantSid = args.key;\n            if (!this.participants.has(participantSid)) {\n              return;\n            }\n            const leftParticipant = this.participants.get(participantSid);\n            this.participants.delete(participantSid);\n            if (!leftParticipant) {\n              return;\n            }\n            this.emit(\"participantLeft\", leftParticipant);\n          });\n\n          rosterMap.on(\"itemUpdated\", (args) => {\n            log.debug(this.conversation.sid + \" itemUpdated: \" + args.item.key);\n            this.upsertParticipant(args.item.key, args.item.data);\n          });\n\n          const participantsPromises: Promise<Participant>[] = [];\n          const rosterMapHandler = (paginator) => {\n            paginator.items.forEach((item) => {\n              participantsPromises.push(\n                this.upsertParticipant(item.key, item.data)\n              );\n            });\n            return paginator.hasNextPage\n              ? paginator.nextPage().then(rosterMapHandler)\n              : null;\n          };\n\n          return rosterMap\n            .getItems()\n            .then(rosterMapHandler)\n            .then(() => Promise.all(participantsPromises))\n            .then(() => rosterMap);\n        })\n        .catch((err) => {\n          this.rosterEntityPromise = null;\n          if (this.services.syncClient.connectionState != \"disconnected\") {\n            log.error(\n              \"Failed to get roster object for conversation\",\n              this.conversation.sid,\n              err\n            );\n          }\n          log.debug(\n            \"ERROR: Failed to get roster object for conversation\",\n            this.conversation.sid,\n            err\n          );\n          throw err;\n        }));\n  }\n\n  async upsertParticipant(\n    participantSid: string,\n    data: ParticipantDescriptor\n  ): Promise<Participant> {\n    let participant = this.participants.get(participantSid);\n    if (participant) {\n      return participant._update(data);\n    }\n\n    const links = {\n      self: `${this.links.participants}/${participantSid}`,\n    };\n\n    participant = new Participant(\n      data,\n      participantSid,\n      this.conversation,\n      links,\n      this.services\n    );\n    this.participants.set(participantSid, participant);\n    participant.on(\"updated\", (args: ParticipantUpdatedEventArgs) =>\n      this.emit(\"participantUpdated\", args)\n    );\n    return participant;\n  }\n\n  /**\n   * @returns {Promise<Array<Participant>>} returns list of participants {@see Participant}\n   */\n  async getParticipants(): Promise<Participant[]> {\n    return this.rosterEntityPromise\n      ? this.rosterEntityPromise.then(() => {\n          const participants: Participant[] = [];\n          this.participants.forEach((participant) =>\n            participants.push(participant)\n          );\n          return participants;\n        })\n      : [];\n  }\n\n  /**\n   * Get participant by SID from conversation\n   * @returns {Promise<Participant>}\n   */\n  async getParticipantBySid(\n    participantSid: string\n  ): Promise<Participant | null> {\n    return this.rosterEntityPromise\n      ? this.rosterEntityPromise.then(() => {\n          const participant = this.participants.get(participantSid);\n          if (!participant) {\n            throw new Error(\n              \"Participant with SID \" + participantSid + \" was not found\"\n            );\n          }\n          return participant;\n        })\n      : null;\n  }\n\n  /**\n   * Get participant by identity from conversation\n   * @returns {Promise<Participant>}\n   */\n  async getParticipantByIdentity(\n    identity: string\n  ): Promise<Participant | null> {\n    let foundParticipant: Participant | null = null;\n    return this.rosterEntityPromise\n      ? this.rosterEntityPromise.then(() => {\n          this.participants.forEach((participant) => {\n            if (participant.identity === identity) {\n              foundParticipant = participant;\n            }\n          });\n          if (!foundParticipant) {\n            throw new Error(\n              \"Participant with identity \" + identity + \" was not found\"\n            );\n          }\n          return foundParticipant;\n        })\n      : null;\n  }\n\n  /**\n   * Add a chat participant to the conversation\n   * @returns {Promise<ParticipantResponse>}\n   */\n  async add(\n    identity: string,\n    attributes: JSONValue\n  ): Promise<ParticipantResponse> {\n    return await this.services.commandExecutor.mutateResource<\n      AddParticipantRequest,\n      ParticipantResponse\n    >(\"post\", this.links.participants, {\n      identity,\n      attributes:\n        typeof attributes !== \"undefined\"\n          ? JSON.stringify(attributes)\n          : undefined,\n    });\n  }\n\n  /**\n   * Add a non-chat participant to the conversation.\n   *\n   * @param proxyAddress\n   * @param address\n   * @param attributes\n   * @param bindingOptions\n   * @returns {Promise<any>}\n   */\n  addNonChatParticipant(\n    proxyAddress: string,\n    address: string,\n    attributes: JSONValue = {},\n    bindingOptions: ParticipantBindingOptions = {}\n  ): Promise<ParticipantResponse> {\n    return this.services.commandExecutor.mutateResource<\n      AddParticipantRequest,\n      ParticipantResponse\n    >(\"post\", this.links.participants, {\n      attributes:\n        typeof attributes !== \"undefined\"\n          ? JSON.stringify(attributes)\n          : undefined,\n      messaging_binding: {\n        address,\n        proxy_address: proxyAddress,\n        name: bindingOptions?.email?.name,\n        level: bindingOptions?.email?.level,\n      },\n    });\n  }\n\n  /**\n   * Remove the participant with a given identity from a conversation.\n   */\n  remove(identity: string): Promise<void> {\n    return this.services.commandExecutor.mutateResource(\n      \"delete\",\n      `${this.links.participants}/${identity}`\n    );\n  }\n}\n\nexport { Participants };\n\n/**\n * Fired when participant joined conversation\n * @event Participants#participantJoined\n * @type {Participant}\n */\n\n/**\n * Fired when participant left conversation\n * @event Participants#participantLeft\n * @type {Participant}\n */\n\n/**\n * Fired when participant updated\n * @event Participants#participantUpdated\n * @type {Object}\n * @property {Participant} participant - Updated Participant\n * @property {Participant#UpdateReason[]} updateReasons - Array of Participant's updated event reasons\n */\n"],"names":["Logger","ReplayEventEmitter","participant","Participant"],"mappings":"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"}