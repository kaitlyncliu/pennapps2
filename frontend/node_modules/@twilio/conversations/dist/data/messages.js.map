{"version":3,"file":"messages.js","sources":["../../src/data/messages.ts"],"sourcesContent":["import { Logger } from \"../logger\";\n\nimport {\n  Message,\n  MessageData,\n  MessageUpdatedEventArgs,\n  MessageUpdateReason,\n} from \"../message\";\nimport {\n  Conversation,\n  SendEmailOptions,\n  SendMediaOptions,\n} from \"../conversation\";\nimport { UnsentMessage } from \"../unsent-message\";\n\nimport { SyncList, SyncClient } from \"twilio-sync\";\nimport { SyncPaginator } from \"../sync-paginator\";\n\nimport { McsClient, McsMedia } from \"@twilio/mcs-client\";\nimport { Network } from \"../services/network\";\nimport { Configuration } from \"../configuration\";\nimport { CommandExecutor } from \"../command-executor\";\nimport { SendMessageRequest } from \"../interfaces/commands/send-message\";\nimport { MessageResponse } from \"../interfaces/commands/message-response\";\nimport { ReplayEventEmitter } from \"@twilio/replay-event-emitter\";\nimport { JSONValue } from \"../types\";\n\ntype MessagesEvents = {\n  messageAdded: (message: Message) => void;\n  messageRemoved: (message: Message) => void;\n  messageUpdated: (data: {\n    message: Message;\n    updateReasons: MessageUpdateReason[];\n  }) => void;\n};\n\nconst log = Logger.scope(\"Messages\");\n\nexport interface MessagesServices {\n  mcsClient: McsClient;\n  network: Network;\n  syncClient: SyncClient;\n  commandExecutor: CommandExecutor;\n}\n\n/**\n * Represents the collection of messages in a conversation\n */\nclass Messages extends ReplayEventEmitter<MessagesEvents> {\n  public readonly conversation: Conversation;\n  private readonly configuration: Configuration;\n  private readonly services: MessagesServices;\n  private readonly messagesByIndex: Map<number, Message>;\n  private messagesListPromise: Promise<SyncList> | null;\n\n  public constructor(\n    conversation: Conversation,\n    configuration: Configuration,\n    services: MessagesServices\n  ) {\n    super();\n\n    this.conversation = conversation;\n    this.configuration = configuration;\n    this.services = services;\n\n    this.messagesByIndex = new Map();\n    this.messagesListPromise = null;\n  }\n\n  /**\n   * Subscribe to the Messages Event Stream\n   * @param name - The name of Sync object for the Messages resource.\n   */\n  public async subscribe(name: string) {\n    if (this.messagesListPromise) {\n      return this.messagesListPromise;\n    }\n\n    this.messagesListPromise = this.services.syncClient.list({\n      id: name,\n      mode: \"open_existing\",\n    });\n\n    try {\n      const list = await this.messagesListPromise;\n\n      list.on(\"itemAdded\", (args) => {\n        log.debug(`${this.conversation.sid} itemAdded: ${args.item.index}`);\n\n        const links = {\n          self: `${this.conversation.links.messages}/${args.item.data.sid}`,\n          conversation: this.conversation.links.self,\n          messages_receipts: `${this.conversation.links.messages}/${args.item.data.sid}/Receipts`,\n        };\n        const message = new Message(\n          args.item.index,\n          args.item.data,\n          this.conversation,\n          links,\n          this.configuration,\n          this.services\n        );\n\n        if (this.messagesByIndex.has(message.index)) {\n          log.debug(\n            \"Message arrived, but is already known and ignored\",\n            this.conversation.sid,\n            message.index\n          );\n          return;\n        }\n\n        this.messagesByIndex.set(message.index, message);\n\n        message.on(\"updated\", (args: MessageUpdatedEventArgs) =>\n          this.emit(\"messageUpdated\", args)\n        );\n\n        this.emit(\"messageAdded\", message);\n      });\n\n      list.on(\"itemRemoved\", (args) => {\n        log.debug(`#{this.conversation.sid} itemRemoved: ${args.index}`);\n\n        const index = args.index;\n\n        if (this.messagesByIndex.has(index)) {\n          const message = this.messagesByIndex.get(index);\n          if (!message) {\n            return;\n          }\n\n          this.messagesByIndex.delete(message.index);\n          message.removeAllListeners(\"updated\");\n          this.emit(\"messageRemoved\", message);\n        }\n      });\n\n      list.on(\"itemUpdated\", (args) => {\n        log.debug(`${this.conversation.sid} itemUpdated: ${args.item.index}`);\n\n        const message = this.messagesByIndex.get(args.item.index);\n\n        if (message) {\n          message._update(args.item.data);\n        }\n      });\n\n      return list;\n    } catch (err) {\n      this.messagesListPromise = null;\n\n      if (this.services.syncClient.connectionState !== \"disconnected\") {\n        log.error(\n          \"Failed to get messages object for conversation\",\n          this.conversation.sid,\n          err\n        );\n      }\n\n      log.debug(\n        \"ERROR: Failed to get messages object for conversation\",\n        this.conversation.sid,\n        err\n      );\n\n      throw err;\n    }\n  }\n\n  public async unsubscribe() {\n    if (!this.messagesListPromise) {\n      return;\n    }\n\n    const entity = await this.messagesListPromise;\n    entity.close();\n    this.messagesListPromise = null;\n  }\n\n  /**\n   * Send Message to the conversation, message could include both text and multiple media attachments.\n   * @param message Message to post\n   * @returns Returns a promise which can fail\n   */\n  public async sendV2(message: UnsentMessage): Promise<MessageResponse> {\n    log.debug(\n      \"Sending message V2\",\n      message.mediaContent,\n      message.attributes,\n      message.emailOptions\n    );\n\n    const media: McsMedia[] = [];\n\n    for (const [category, mediaContent] of message.mediaContent) {\n      log.debug(\n        `Adding media to a message as ${\n          mediaContent instanceof FormData ? \"FormData\" : \"SendMediaOptions\"\n        }`,\n        mediaContent\n      );\n\n      media.push(\n        mediaContent instanceof FormData\n          ? await this.services.mcsClient.postFormData(mediaContent, category)\n          : await this.services.mcsClient.post(\n              mediaContent.contentType ?? \"\",\n              mediaContent.media ?? \"\",\n              category,\n              mediaContent.filename\n            )\n      );\n    }\n\n    return await this.services.commandExecutor.mutateResource<\n      SendMessageRequest,\n      MessageResponse\n    >(\"post\", this.conversation.links.messages, {\n      body: message.text,\n      subject: message.emailOptions?.subject,\n      media_sids: media.map((m) => m.sid),\n      attributes:\n        typeof message.attributes !== \"undefined\"\n          ? JSON.stringify(message.attributes)\n          : undefined,\n    });\n  }\n\n  /**\n   * Send Message to the conversation\n   * @param message Message to post\n   * @param attributes Message attributes\n   * @param emailOptions Options that modify E-mail integration behaviors.\n   * @returns Returns promise which can fail\n   */\n  public async send(\n    message: null | string | FormData | SendMediaOptions,\n    attributes: JSONValue = {},\n    emailOptions?: SendEmailOptions\n  ): Promise<MessageResponse> {\n    log.debug(\"Sending text message\", message, attributes, emailOptions);\n\n    return await this.services.commandExecutor.mutateResource<\n      SendMessageRequest,\n      MessageResponse\n    >(\"post\", this.conversation.links.messages, {\n      body: message ?? \"\",\n      attributes:\n        typeof attributes !== \"undefined\"\n          ? JSON.stringify(attributes)\n          : undefined,\n      subject: emailOptions?.subject,\n    });\n  }\n\n  /**\n   * Send Media Message to the conversation\n   * @param mediaContent Media content to post\n   * @param attributes Message attributes\n   * @param emailOptions Email options\n   * @returns Returns promise which can fail\n   */\n  public async sendMedia(\n    mediaContent: FormData | SendMediaOptions,\n    attributes: JSONValue = {},\n    emailOptions?: SendEmailOptions\n  ) {\n    log.debug(\"Sending media message\", mediaContent, attributes, emailOptions);\n    log.debug(\n      `Sending media message as ${\n        mediaContent instanceof FormData ? \"FormData\" : \"SendMediaOptions\"\n      }`,\n      mediaContent,\n      attributes\n    );\n\n    const media: McsMedia =\n      mediaContent instanceof FormData\n        ? await this.services.mcsClient.postFormData(mediaContent)\n        : await this.services.mcsClient.post(\n            mediaContent.contentType ?? \"\",\n            mediaContent.media ?? \"\",\n            \"media\",\n            mediaContent.filename\n          );\n\n    // emailOptions are currently ignored for media messages.\n    return await this.services.commandExecutor.mutateResource<\n      SendMessageRequest,\n      MessageResponse\n    >(\"post\", this.conversation.links.messages, {\n      media_sids: [media.sid],\n      attributes:\n        typeof attributes !== \"undefined\"\n          ? JSON.stringify(attributes)\n          : undefined,\n    });\n  }\n\n  /**\n   * Returns messages from conversation using paginator interface\n   * @param pageSize Number of messages to return in single chunk. By default it's 30.\n   * @param anchor Most early message id which is already known, or 'end' by default\n   * @param direction Pagination order 'backwards' or 'forward', 'forward' by default\n   * @returns Last page of messages by default\n   */\n  public async getMessages(\n    pageSize: number | undefined,\n    anchor: number | \"end\" | undefined,\n    direction: \"forward\" | \"backwards\" = \"backwards\"\n  ): Promise<SyncPaginator<Message>> {\n    return this._getMessages(pageSize, anchor, direction);\n  }\n\n  private _wrapPaginator(order, page, op) {\n    // Due to an inconsistency between Sync and Chat conventions, next and\n    // previous pages should be swapped.\n    const shouldReverse = order === \"desc\";\n\n    const nextPage = () =>\n      page.nextPage().then((page) => this._wrapPaginator(order, page, op));\n    const previousPage = () =>\n      page.prevPage().then((page) => this._wrapPaginator(order, page, op));\n\n    return op(page.items).then((items) => ({\n      items: items.sort((x, y) => {\n        return x.index - y.index;\n      }),\n      hasPrevPage: shouldReverse ? page.hasNextPage : page.hasPrevPage,\n      hasNextPage: shouldReverse ? page.hasPrevPage : page.hasNextPage,\n      prevPage: shouldReverse ? nextPage : previousPage,\n      nextPage: shouldReverse ? previousPage : nextPage,\n    }));\n  }\n\n  private _upsertMessage(index: number, value: MessageData) {\n    const cachedMessage = this.messagesByIndex.get(index);\n\n    if (cachedMessage) {\n      return cachedMessage;\n    }\n\n    const links = {\n      self: `${this.conversation.links.messages}/${value.sid}`,\n      conversation: this.conversation.links.self,\n      messages_receipts: `${this.conversation.links.messages}/${value.sid}/Receipts`,\n    };\n    const message = new Message(\n      index,\n      value,\n      this.conversation,\n      links,\n      this.configuration,\n      this.services\n    );\n\n    this.messagesByIndex.set(message.index, message);\n\n    message.on(\"updated\", (args: MessageUpdatedEventArgs) =>\n      this.emit(\"messageUpdated\", args)\n    );\n\n    return message;\n  }\n\n  /**\n   * Returns last messages from conversation\n   * @param {Number} [pageSize] Number of messages to return in single chunk. By default it's 30.\n   * @param {String} [anchor] Most early message id which is already known, or 'end' by default\n   * @param {String} [direction] Pagination order 'backwards' or 'forward', or 'forward' by default\n   * @returns {Promise<SyncPaginator<Message>>} last page of messages by default\n   * @private\n   */\n  private async _getMessages(\n    pageSize = 30,\n    anchor: number | \"end\" = \"end\",\n    direction: \"forward\" | \"backwards\" = \"forward\"\n  ): Promise<SyncPaginator<Message>> {\n    const order = direction === \"backwards\" ? \"desc\" : \"asc\";\n    const list = await this.messagesListPromise;\n    const page = await list?.getItems({\n      from: anchor !== \"end\" ? anchor : void 0,\n      pageSize,\n      order,\n      limit: pageSize, // @todo Limit equals pageSize by default in Sync. This is probably not ideal.\n    });\n\n    return await this._wrapPaginator(order, page, (items) =>\n      Promise.all(\n        items.map((item) => this._upsertMessage(item.index, item.data))\n      )\n    );\n  }\n}\n\nexport { Messages };\n"],"names":["Logger","ReplayEventEmitter","message","Message"],"mappings":"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"}